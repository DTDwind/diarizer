#!/usr/bin/env bash
# This script is modified from run_example.sh and uses Lhotse to first prepare the
# data in the required format before running the model.
. ./path.sh

DATA_DIR=/export/corpora5/amicorpus
EXP_DIR=exp/ami

mkdir -p exp

# Hyperparameters (from original repo)
Fa=0.4
Fb=64
loopP=0.65

python local/prepare_ami.py --data-dir $DATA_DIR --output-dir example/ami

# run feature and x-vectors extraction
for split in dev test; do
(
for audio in $(ls example/ami/${split}/audios/*.wav | xargs -n 1 basename)
do
      filename=$(echo "${audio}" | cut -f 1 -d '.')
      echo ${filename} > exp/list_${filename}.txt
      utils/retry.pl utils/queue-freegpu.pl -l "hostname=c*" --gpu 1 --mem 2G \
      $EXP_DIR/${split}/log/xvec_${filename}.log \
      python VBx/predict.py \
            --gpus true \
            --in-file-list exp/list_${filename}.txt \
            --in-lab-dir example/ami/${split}/vad \
            --in-wav-dir example/ami/${split}/audios \
            --out-ark-fn $EXP_DIR/${split}/${filename}.ark \
            --out-seg-fn $EXP_DIR/${split}/${filename}.seg \
            --model ResNet101 \
            --weights VBx/models/ResNet101_16kHz/nnet/raw_81.pth \
            --backend pytorch &
      sleep 10
done
wait
)
done

# Run VBx diarization
echo "Running VBx with Fa=$Fa, Fb=$Fb, loopP=$loopP"
for split in dev test; do
(
for audio in $(ls example/ami/${split}/audios/*.wav | xargs -n 1 basename)
do
      filename=$(echo "${audio}" | cut -f 1 -d '.')
      utils/queue.pl --mem 2G $EXP_DIR/$split/log/vb_${filename}.log \
        python VBx/vbhmm.py \
            --init AHC+VB \
            --out-rttm-dir $EXP_DIR/$split/out \
            --xvec-ark-file $EXP_DIR/$split/${filename}.ark \
            --segments-file $EXP_DIR/$split/${filename}.seg \
            --xvec-transform VBx/models/ResNet101_16kHz/transform.h5 \
            --plda-file VBx/models/ResNet101_16kHz/plda \
            --threshold -0.015 \
            --init-smoothing 7.0 \
            --lda-dim 128 \
            --Fa $Fa \
            --Fb $Fb \
            --loopP $loopP &
      sleep 10
done
wait
)
done

# Combine all RTTM files and score
for split in dev test; do
  echo "Evaluating $split"
  cat example/ami/$split/rttm/*.rttm > exp/ref.rttm
  cat exp/ami/$split/out/*.rttm > exp/hyp.rttm
  LC_ALL= spyder --per-file exp/ref.rttm exp/hyp.rttm
done

# RESULTS
# Evaluating dev
# Evaluated 18 recordings on `all` regions. Results:
# ╒═════════════╤════════════════╤═════════╤════════════╤═════════╤════════╕
# │ Recording   │   Duration (s) │   Miss. │   F.Alarm. │   Conf. │    DER │
# ╞═════════════╪════════════════╪═════════╪════════════╪═════════╪════════╡
# │ ES2011a     │        1091.72 │  20.26% │      0.00% │  18.90% │ 39.16% │
# ├─────────────┼────────────────┼─────────┼────────────┼─────────┼────────┤
# │ ES2011b     │        1587.99 │  17.23% │      0.00% │   5.51% │ 22.73% │
# ├─────────────┼────────────────┼─────────┼────────────┼─────────┼────────┤
# │ ES2011c     │        1819.96 │  24.41% │      0.00% │   5.67% │ 30.08% │
# ├─────────────┼────────────────┼─────────┼────────────┼─────────┼────────┤
# │ ES2011d     │        1981.21 │  23.26% │      0.00% │  12.66% │ 35.93% │
# ├─────────────┼────────────────┼─────────┼────────────┼─────────┼────────┤
# │ IB4001      │        1742.28 │  20.00% │      0.00% │   4.45% │ 24.45% │
# ├─────────────┼────────────────┼─────────┼────────────┼─────────┼────────┤
# │ IB4002      │        1884.01 │  28.73% │      0.00% │   4.87% │ 33.59% │
# ├─────────────┼────────────────┼─────────┼────────────┼─────────┼────────┤
# │ IB4003      │        2269.65 │  16.91% │      0.00% │   1.54% │ 18.46% │
# ├─────────────┼────────────────┼─────────┼────────────┼─────────┼────────┤
# │ IB4004      │        2875.57 │  22.07% │      0.00% │   1.93% │ 24.00% │
# ├─────────────┼────────────────┼─────────┼────────────┼─────────┼────────┤
# │ IB4010      │        3500.53 │  23.27% │      0.00% │   2.77% │ 26.04% │
# ├─────────────┼────────────────┼─────────┼────────────┼─────────┼────────┤
# │ IB4011      │        2740.14 │  20.31% │      0.00% │   3.10% │ 23.41% │
# ├─────────────┼────────────────┼─────────┼────────────┼─────────┼────────┤
# │ IS1008a     │         854.92 │   6.76% │      0.00% │   1.75% │  8.51% │
# ├─────────────┼────────────────┼─────────┼────────────┼─────────┼────────┤
# │ IS1008b     │        1612.20 │   8.21% │      0.00% │   3.06% │ 11.28% │
# ├─────────────┼────────────────┼─────────┼────────────┼─────────┼────────┤
# │ IS1008c     │        1562.54 │  15.05% │      0.00% │   2.95% │ 18.00% │
# ├─────────────┼────────────────┼─────────┼────────────┼─────────┼────────┤
# │ IS1008d     │        1498.82 │  16.20% │      0.00% │   2.11% │ 18.31% │
# ├─────────────┼────────────────┼─────────┼────────────┼─────────┼────────┤
# │ TS3004a     │        1185.71 │  19.86% │      0.00% │  16.59% │ 36.45% │
# ├─────────────┼────────────────┼─────────┼────────────┼─────────┼────────┤
# │ TS3004b     │        2371.48 │  17.25% │      0.00% │   4.61% │ 21.86% │
# ├─────────────┼────────────────┼─────────┼────────────┼─────────┼────────┤
# │ TS3004c     │        2488.27 │  18.31% │      0.00% │   5.36% │ 23.67% │
# ├─────────────┼────────────────┼─────────┼────────────┼─────────┼────────┤
# │ TS3004d     │        2428.22 │  19.61% │      0.00% │  11.74% │ 31.35% │
# ├─────────────┼────────────────┼─────────┼────────────┼─────────┼────────┤
# │ Overall     │       35495.22 │  19.51% │      0.00% │   5.51% │ 25.02% │
# ╘═════════════╧════════════════╧═════════╧════════════╧═════════╧════════╛

# Evaluating test
# Evaluated 16 recordings on `all` regions. Results:
# ╒═════════════╤════════════════╤═════════╤════════════╤═════════╤════════╕
# │ Recording   │   Duration (s) │   Miss. │   F.Alarm. │   Conf. │    DER │
# ╞═════════════╪════════════════╪═════════╪════════════╪═════════╪════════╡
# │ EN2002a     │        2910.97 │  33.18% │      0.00% │  11.90% │ 45.08% │
# ├─────────────┼────────────────┼─────────┼────────────┼─────────┼────────┤
# │ EN2002b     │        2173.78 │  30.09% │      0.00% │  12.74% │ 42.83% │
# ├─────────────┼────────────────┼─────────┼────────────┼─────────┼────────┤
# │ EN2002c     │        3551.64 │  25.40% │      0.00% │  10.34% │ 35.74% │
# ├─────────────┼────────────────┼─────────┼────────────┼─────────┼────────┤
# │ EN2002d     │        3042.98 │  35.03% │      0.00% │   9.54% │ 44.57% │
# ├─────────────┼────────────────┼─────────┼────────────┼─────────┼────────┤
# │ ES2004a     │        1051.71 │  21.29% │      0.00% │  15.40% │ 36.69% │
# ├─────────────┼────────────────┼─────────┼────────────┼─────────┼────────┤
# │ ES2004b     │        2403.80 │  13.91% │      0.00% │   4.29% │ 18.20% │
# ├─────────────┼────────────────┼─────────┼────────────┼─────────┼────────┤
# │ ES2004c     │        2439.53 │  15.46% │      0.00% │   3.04% │ 18.50% │
# ├─────────────┼────────────────┼─────────┼────────────┼─────────┼────────┤
# │ ES2004d     │        2258.48 │  20.08% │      0.00% │   9.74% │ 29.82% │
# ├─────────────┼────────────────┼─────────┼────────────┼─────────┼────────┤
# │ IS1009a     │         771.77 │  18.55% │      0.00% │   5.84% │ 24.39% │
# ├─────────────┼────────────────┼─────────┼────────────┼─────────┼────────┤
# │ IS1009b     │        2074.64 │  13.39% │      0.00% │   2.00% │ 15.39% │
# ├─────────────┼────────────────┼─────────┼────────────┼─────────┼────────┤
# │ IS1009c     │        1680.33 │   8.62% │      0.00% │   2.56% │ 11.17% │
# ├─────────────┼────────────────┼─────────┼────────────┼─────────┼────────┤
# │ IS1009d     │        1891.67 │  15.53% │      0.00% │   3.55% │ 19.08% │
# ├─────────────┼────────────────┼─────────┼────────────┼─────────┼────────┤
# │ TS3003a     │        1209.19 │  12.90% │      0.00% │  19.78% │ 32.68% │
# ├─────────────┼────────────────┼─────────┼────────────┼─────────┼────────┤
# │ TS3003b     │        2011.71 │   8.75% │      0.00% │   2.96% │ 11.70% │
# ├─────────────┼────────────────┼─────────┼────────────┼─────────┼────────┤
# │ TS3003c     │        2086.65 │   9.03% │      0.00% │   7.57% │ 16.60% │
# ├─────────────┼────────────────┼─────────┼────────────┼─────────┼────────┤
# │ TS3003d     │        2394.10 │  16.87% │      0.00% │  13.86% │ 30.74% │
# ├─────────────┼────────────────┼─────────┼────────────┼─────────┼────────┤
# │ Overall     │       33952.95 │  19.91% │      0.00% │   8.32% │ 28.23% │
# ╘═════════════╧════════════════╧═════════╧════════════╧═════════╧════════╛
